/**
 * Content/Pushdown Manager System
 * Manages fly system and user/page banner interaction
 * Supports all formats (mobile/desktop/content)
 *
 * @version 2.4.5
 * @author Alessandro Maurizio <alessandro.maurizio@altervista.it>
 * @preserve
 */
class AVPushdownManager{constructor(t){this.loader=t,this.loader||this.loader.instanceName.includes("AVPushdown")?(this.log=function(t,e){this.loader.log(t,e,"Manager")},this.statusFlags={enabled:!1,isFlying:!1,isAnimating:!1,viewed:!1,closed:!1,creativity:!1,isButton:!1},this.init()):console.error("%c[AVPushdown] %c[Manager] %c[FATAL] %cQuesta classe AVPushdownManager puo' essere inizializzata solo da AVPushdownLoader","color: #b78114","color: #2f74e2","color: #ef4c37","color: #24ada4")}init(){this.constructor.addListenerMulti(window,"load resize scroll",this.toggleFlight.bind(this)),this.constructor.addListenerMulti(window,"resize",this.resizeHeight.bind(this)),this.log("Avvio AVPushdown Manager completato - in attesa di eventi..")}registerEvent(t){"pushdown_init"===t?this.resizeHeight():"preroll_served"===t?(this.loader.opt.flightEnabled&&this.launchFlightMode(),this.statusFlags.creativity=!0):"preroll_viewed"===t&&this.statusFlags.creativity?(this.statusFlags.viewed=!0,this.loader.htmlElems.closePush.classList.add("enabled"),this.loader.opt.swipeEnabled&&this.swipeRightToClose(),"mobile"===this.loader.opt.type?"function"==typeof av_confirm_callback_pushmob&&av_confirm_callback_pushmob():"desktop"===this.loader.opt.type&&"function"==typeof av_confirm_callback_pushdesk&&av_confirm_callback_pushdesk()):"preroll_error"===t||"preroll_not_served"===t?(this.loader.htmlElems.closePush.classList.add("enabled"),this.loader.opt.swipeEnabled&&this.swipeRightToClose()):"content_played"===t&&this.resizeHeight(),this.loader.track(t)}launchFlightMode(){this.loader.htmlElems.flCont.classList.add("anim-"+this.loader.opt.flyMode);let t=this;this.loader.htmlElems.stCont.classList.add("active"),this.statusFlags.enabled=!0,this.toggleFlight(),this.constructor.addListenerMulti(this.loader.htmlElems.closePush,"click",function(){t.statusFlags.viewed&&(t.flyUp(),t.statusFlags.closed=!0,t.loader.opt.pausePrerollOnClose&&t.loader.advPlayer&&t.loader.advPlayer.pausePreroll(),t.loader.track("flight_closed"))})}resizeHeight(){if(this.statusFlags.isFlying&&this.statusFlags.enabled&&this.loader.opt.keepAspectRatio&&(this.loader.htmlElems.flCont.style.height=this.loader.htmlElems.flCont.offsetWidth*(9/16)+"px"),"content"!==this.loader.opt.mode||this.statusFlags.isFlying||this.loader.opt.keepAspectRatio&&(this.loader.htmlElems.wrapper.style.height=this.loader.htmlElems.wrapper.offsetWidth*(9/16)+"px"),/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream){let t=this.loader.htmlElems.mainFrame;t&&(t.style.height=this.loader.htmlElems.flCont.offsetHeight-2+"px",t.style.width="calc(100% - 4px)")}this.requestAdResize()}flyDown(){let t=this,e=10;"fade"===this.loader.opt.flyMode&&(e=100),t.loader.htmlElems.flCont.classList.contains("inflight")||t.statusFlags.closed||!t.statusFlags.enabled||(t.loader.htmlElems.flCont.classList.add("inflight-transition-"+t.loader.opt.flyMode),t.statusFlags.isAnimating=!0,setTimeout(function(){t.loader.htmlElems.flCont.classList.add("inflight"),t.loader.htmlElems.flCont.classList.remove("inflight-transition-"+t.loader.opt.flyMode),t.statusFlags.isFlying=!0,t.statusFlags.isAnimating=!1,t.resizeHeight()},e))}flyUp(){let t=this;this.statusFlags.isButton&&this.closeButtonMode();let e=250;"fade"===this.loader.opt.flyMode&&(e=100),"slide"===this.loader.opt.flyMode&&(e=200),t.loader.htmlElems.flCont.classList.contains("inflight")&&t.statusFlags.enabled&&(t.loader.htmlElems.flCont.classList.add("inflight-transition-"+t.loader.opt.flyMode),t.loader.htmlElems.flCont.querySelectorAll("iframe")[0].removeAttribute("style"),t.loader.htmlElems.flCont.style.bottom="",t.statusFlags.isAnimating=!0,setTimeout(function(){t.loader.htmlElems.flCont.classList.remove("inflight-transition-"+t.loader.opt.flyMode),t.loader.htmlElems.flCont.classList.remove("inflight"),t.loader.htmlElems.flCont.querySelectorAll("iframe")[0].removeAttribute("style"),t.loader.htmlElems.flCont.removeAttribute("style"),t.statusFlags.isFlying=!1,t.statusFlags.isAnimating=!1,t.requestAdResize()},e))}requestAdResize(){if(this.loader.advPlayer){let t=window.getComputedStyle(this.loader.htmlElems.flCont),e=Math.round(parseFloat(t.getPropertyValue("width"))),s=Math.round(parseFloat(t.getPropertyValue("height")));this.loader.advPlayer.requestResize(e,s)}}manageSpecialCases(){let t=!1;(this.statusFlags.isFlying||this.statusFlags.isAnimating)&&(this.interElems={fixedBanner:document.getElementById("fixed_banner"),outBrain:document.getElementById("outbrain_widget_1"),adformAdbox:document.getElementsByClassName("adform-adbox")[0],adkFooter:document.getElementById("adk_footer"),ameFooter:document.getElementById("strip_adv"),ameFooter2:document.getElementsByClassName("strip-mobile")[0],adkThirdP:document.getElementsByClassName("footer_push_interaction")[0]},this.interElems.fixedBanner&&this.constructor.isVisible(this.interElems.fixedBanner)&&(this.loader.htmlElems.flCont.style.bottom=this.interElems.fixedBanner.offsetHeight+5+"px",t=!0),this.interElems.adkFooter&&this.constructor.isVisible(this.interElems.adkFooter)&&(this.loader.htmlElems.flCont.style.bottom=this.interElems.adkFooter.offsetHeight+5+"px",t=!0),this.interElems.adkThirdP&&this.constructor.isVisible(this.interElems.adkThirdP)&&(this.loader.htmlElems.flCont.style.bottom=this.interElems.adkThirdP.offsetHeight+5+"px",t=!0),this.interElems.ameFooter2&&this.constructor.isVisible(this.interElems.ameFooter2)&&"0px"===window.getComputedStyle(this.interElems.ameFooter2).bottom&&(this.loader.htmlElems.flCont.style.bottom=this.interElems.ameFooter2.offsetHeight+5+"px",t=!0),this.interElems.ameFooter&&this.constructor.isVisible(this.interElems.ameFooter)&&"0px"===window.getComputedStyle(this.interElems.ameFooter).bottom&&(this.loader.htmlElems.flCont.style.bottom=this.interElems.ameFooter.offsetHeight+5+"px",t=!0),this.interElems.outBrain&&this.interElems.outBrain.classList.contains("ob-shrink-show")&&(this.loader.htmlElems.flCont.style.bottom=this.interElems.outBrain.offsetHeight+5+"px",t=!0),this.interElems.adformAdbox&&this.interElems.adformAdbox.classList.contains("adform-adbox-fixed-B")&&this.interElems.adformAdbox.firstChild&&this.interElems.adformAdbox.firstChild.offsetWidth>0&&(this.loader.htmlElems.flCont.style.bottom=this.interElems.adformAdbox.offsetHeight+5+"px",t=!0)),t||(this.loader.htmlElems.flCont.style.bottom="")}toggleFlight(){let t=this;!t.statusFlags.isAnimating&&t.statusFlags.enabled&&(t.detatchLimitCrossed()&&!t.statusFlags.isFlying?(t.flyDown(),t.manageSpecialCases()):!t.detatchLimitCrossed()&&t.statusFlags.isFlying?(t.manageSpecialCases(),t.flyUp()):t.manageSpecialCases())}launchButtonMode(){this.statusFlags.isFlying&&(this.loader.htmlElems.flCont.classList.add("button-mode"),this.loader.contentPlayer.videoElement.parentNode.classList.add("button-mode"),this.loader.contentPlayer.htmlElems.videoButton.style.opacity="1",this.loader.contentPlayer.htmlElems.videoButton.style.pointerEvents="all",this.statusFlags.isButton=!0)}closeButtonMode(){this.loader.htmlElems.flCont.classList.remove("button-mode"),this.loader.contentPlayer.videoElement.parentNode.classList.remove("button-mode"),this.loader.contentPlayer.htmlElems.videoButton.style.opacity="0",this.loader.contentPlayer.htmlElems.videoButton.style.pointerEvents="none",this.statusFlags.isButton=!1}detatchLimitCrossed(){let t=this.loader.htmlElems.stCont.getBoundingClientRect(),e=.25*t.height;return"fade"!==this.loader.opt.flyMode&&"slide"!==this.loader.opt.flyMode||(e=.8*t.height),t.top+e<0}static addListenerMulti(t,e,s){e.split(" ").forEach(e=>t.addEventListener(e,s,{capture:!1,passive:!0}))}static removeListenerMulti(t,e,s){e.split(" ").forEach(e=>t.removeEventListener(e,s,{capture:!1,passive:!0}))}static isVisible(t){return!!(t.offsetWidth||t.offsetHeight||t.getClientRects().length)}swipeRightToClose(){let t=this,e=0,s=100,l=0,i=0,o=this.loader.htmlElems.pushResultDiv;if(!o)return void this.log("Impossibile trovare l'elemento di aggancio per il sistema swipe!","ERROR");let a=function(t){t.touches&&(t=t.touches[0]);if(!this.statusFlags.isFlying)return;0===e&&(e=1,l=t.screenX)}.bind(t),r=function(){i>s?function(){let t=this;t.statusFlags.viewed&&t.loader.htmlElems.flCont.classList.contains("inflight")&&t.statusFlags.enabled&&(t.statusFlags.isButton&&t.closeButtonMode(),t.loader.htmlElems.flCont.style.marginRight="",t.loader.htmlElems.flCont.classList.add("closingRight"),t.statusFlags.isAnimating=!0,setTimeout(function(){t.loader.htmlElems.flCont.classList.remove("closingRight"),t.loader.htmlElems.flCont.classList.remove("inflight"),t.loader.htmlElems.flCont.removeAttribute("style"),t.loader.htmlElems.flCont.querySelectorAll("iframe")[0].removeAttribute("style"),t.statusFlags.isFlying=!1,t.statusFlags.isAnimating=!1,t.statusFlags.closed=!0,t.requestAdResize(),t.loader.opt.pausePrerollOnClose&&t.loader.advPlayer&&t.loader.advPlayer.pausePreroll(),d()},250),t.loader.track("flight_swiped_closed"))}.bind(this)():this.loader.htmlElems.flCont.style.marginRight="";l=0,i=0,e=0}.bind(t),n=function(t){1!==e&&2!==e||(t.touches&&(t=t.touches[0]),i=t.screenX-l,this.loader.htmlElems.flCont.style.marginRight=-i+"px")}.bind(t);function d(){t.constructor.removeListenerMulti(o,"mousedown touchstart",a),t.constructor.removeListenerMulti(o,"mouseup touchend",r),t.constructor.removeListenerMulti(o,"mousemove touchmove",n)}t.constructor.addListenerMulti(o,"mousedown touchstart",a),t.constructor.addListenerMulti(o,"mouseup touchend",r),t.constructor.addListenerMulti(o,"mousemove touchmove",n)}}
