<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Fermate ATM</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
    <div id="home"></div>
    <div id="fermate"></div>
<script>

let cors = 'https://cors-anywhere.herokuapp.com/';
let url = 'https://giromilano.atm.it/proxy.ashx';
let searchParams = new URLSearchParams(window.location.search);
let fermate = [];

if (searchParams.has('martina')) {
    // preimpostato per martina
    fermate.push(11175,11176,10890,10893);
}
if (searchParams.has('quetz')) {
    // preimpostato per quetz
    fermate.push(11175,11176,10890,10893);
}
if (searchParams.has('fermate')) {
    // se ci sono le fermate specificate le tiro fuori
    // filtro solo i numeri dalla query
    let filter = searchParams.get('fermate').split(',');
    filter = filter.map(el => {
        let n = Number(el);
        return  isNaN(n) ? null : n;
    }).filter(function (el) {
        return el != null;
    });
    // unisco la query pulita alle eventuali fermate giÃ  raccolte
    fermate = fermate.concat(filter);
}

fermate.sort((a, b) => a - b);;
console.log(fermate);

if (fermate.length == 0) {
    // se dopo tutto sto giro non ci sono comunque fermate creo la home vuota
    html = "<div class='home'>";
        html+= "<h1>Fermate ATM</h1>";
        html+= "<h2>Come funziona</h2>";
        html+= '<p>Questo tool serve a recuperare i tempi di attesa nelle fermate specificate, per usarlo basta inserire nella url le fermate richieste usando la stringa "?fermate=10000,20000,30000" sostituendo i numeri con le fermate preferite, sempre separate da una virgola</p>';
    html+= "</div>";
    $('#home').append(html);
} else {
    // se ci sono fermate le chiamo in ordine
    fermate.forEach(function(element) {
        console.log(element);
        chiamafermata(element, 'stops');
    });
}

function chiamafermata(fermataid, tipo) {
    var fd = new FormData();   
    fd.append("url", "tpPortal/geodata/pois/" + tipo + "/" + fermataid);
    $.ajax({
        type: "POST",
        url: cors + url,
        crossDomain: true,
        contentType: false,
        processData: false,
        data: fd,
        success: function (data) {
            // do something with server response data
            console.log(data);
            creafermata(fermataid, data);
        },
        error: function (err) {
            console.log(err);
            // handle your error logic here
        }
    });
}

function creafermata(id, info) {
    if (info['Lines'][0]['WaitMessage'] != 'soppressa') {
        html = "<div class='fermata'>";
        html+= "<span class='title'>" + info['Description'] + "</span> - ";
        html+= "<span class='linea'>" + info['Lines'][0]['Line']['LineCode'] + "</span> - ";
        html+= "<span class='linea'>Direzione: " + info['Lines'][0]['Line']['LineDescription'].split(" - ").pop() + "</span> - ";
        html+= "<span class='orario'>" + info['Lines'][0]['WaitMessage'] + "</span>";
        html+= "</div>";
        $('#fermate').append(html);
    }
    console.log(info['Lines'][0]['BookletUrl2']);
}

</script>
    
</body>
</html>